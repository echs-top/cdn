name: 构建并上传Answer UI

# 触发器：只保留手动触发 (workflow_dispatch)，需要时在 GitHub Actions 界面点击 Run workflow
on:
  workflow_dispatch:

jobs:
  build_and_deploy_answer_ui:
    runs-on: ubuntu-latest
    # 授予写入权限，以便 Git 可以在作业结束时推送到当前仓库
    permissions:
      contents: write 

    steps:
      - name: 1. 检出当前仓库代码 (用于后续部署)
        uses: actions/checkout@v4
        with:
          # 将当前仓库代码检出到名为 current_repo 的目录
          path: current_repo

      - name: 2. 拉取 apache/answer 仓库 (release/1.6.0)
        uses: actions/checkout@v4
        with:
          repository: apache/answer
          ref: release/1.6.0
          # 将 Answer 源码检出到名为 answer_source 的目录
          path: answer_source 
      
      # --- 环境设置与缓存开始 ---
      - name: 3. 设置 Go 环境 (v1.23) 并启用缓存
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true # 自动启用 Go 模块和构建缓存

      - name: 4. 设置 Node.js 环境 (v20)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 5. 设置 pnpm (v9)
        uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false # 仅设置 pnpm 版本

      - name: 6. 缓存 pnpm 依赖
        uses: actions/cache@v4
        with:
          # pnpm 缓存目录
          path: ~/.pnpm-store
          # 使用 UI 项目的 pnpm-lock.yaml 文件来生成缓存 key
          key: ${{ runner.os }}-pnpm-${{ hashFiles('answer_source/ui/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      # --- 环境设置与缓存结束 ---

      - name: 7. 安装 Go 依赖工具 (mockgen v1.6.0, wire v0.5.0)
        run: |
          echo "Installing mockgen..."
          # 安装 mockgen (v1.6.0)
          go install github.com/golang/mock/mockgen@v1.6.0
          echo "Installing wire..."
          # 安装 wire (v0.5.0)
          go install github.com/google/wire/cmd/wire@v0.5.0

      - name: 8. 修改 .env.production 中的 PUBLIC_URL (新增加的步骤)
        working-directory: answer_source/ui
        run: |
          ENV_FILE=".env.production"
          
          echo "正在修改 $ENV_FILE 中的 PUBLIC_URL..."
          # 使用 sed 命令将 PUBLIC_URL=/ 替换为 PUBLIC_URL=https://cdn.echs.top/build
          sed -i 's|PUBLIC_URL=/|PUBLIC_URL=https://cdn.echs.top/build|g' $ENV_FILE
          
          echo "--- 确认修改后的 PUBLIC_URL ---"
          grep "PUBLIC_URL" $ENV_FILE
          echo "--------------------------------"
          
      # --- 构建 Answer UI 开始 ---

      - name: 9. 制作 UI 构建 (make ui)
        working-directory: answer_source # 切换到 Answer 源码目录执行 make
        # make ui 将使用第 8 步修改后的 PUBLIC_URL 进行构建
        run: make ui 

      # --- 上传结果到当前仓库根目录 ---
      
      - name: 10. 移动构建文件到当前仓库的根目录
        run: |
          SOURCE_DIR=answer_source/ui/build

          if [ -d "$SOURCE_DIR" ]; then
            # 切换到当前仓库的检出目录
            cd current_repo
            
            # 清理旧的 build 文件夹
            rm -rf build
            
            # 移动构建结果到当前仓库的根目录 (文件夹名称保持为 build)
            mv ../$SOURCE_DIR ./
            
          else
            echo "错误：未找到构建目录 $SOURCE_DIR，make ui 可能失败。"
            exit 1
          fi

      - name: 11. 提交并推送构建文件夹
        run: |
          cd current_repo
          
          # 设置 Git 用户信息为 GitHub Actions Bot
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          
          # 暂存 build 文件夹
          git add build
          
          # 检查是否有更改需要提交
          if git diff --staged --quiet; then
            echo "UI 构建文件无变化，跳过推送。"
          else
            echo "发现新的 UI 构建文件，正在提交..."
            # [skip ci] 确保这个提交不会再次触发这个工作流，避免无限循环
            git commit -m "Build: Update Answer UI build from apache/answer release/1.6.0 [skip ci]"
            git push
          fi
